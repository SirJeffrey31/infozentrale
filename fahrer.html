<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nachlieferungen - Fahrer</title>
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Nachlieferungen&quot;,&quot;short_name&quot;:&quot;Nachlieferungen&quot;,&quot;display&quot;:&quot;standalone&quot;}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 15px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            padding: 15px 0 20px;
            border-bottom: 2px solid #4ade80;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 20px;
            color: #4ade80;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.7;
        }

        .header .time {
            font-size: 28px;
            font-weight: 300;
            margin-top: 10px;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .alert-banner.show {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-banner .alert-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-banner .alert-content {
            font-size: 18px;
            font-weight: 700;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ranking-card {
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .ranking-card.rank-1 {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.4), rgba(217, 119, 6, 0.4));
            border: 2px solid #f59e0b;
        }

        .ranking-card.rank-2 {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.3), rgba(107, 114, 128, 0.3));
            border: 2px solid #9ca3af;
        }

        .ranking-card.rank-3 {
            background: linear-gradient(135deg, rgba(180, 83, 9, 0.3), rgba(146, 64, 14, 0.3));
            border: 2px solid #b45309;
        }

        .ranking-card.rank-other {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ranking-card.abwesend {
            opacity: 0.4;
            border-style: dashed;
        }

        .ranking-card.has-kunde {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(185, 28, 28, 0.2));
        }

        .rank-badge {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .rank-1 .rank-badge { background: #f59e0b; color: #000; }
        .rank-2 .rank-badge { background: #9ca3af; color: #000; }
        .rank-3 .rank-badge { background: #b45309; color: #fff; }
        .rank-other .rank-badge { background: rgba(255,255,255,0.1); }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-info .driver-name {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kunde-info {
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            border-left: 3px solid #ef4444;
        }

        .kunde-info .label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .kunde-info .kunde-name {
            font-size: 14px;
            font-weight: 600;
        }

        .status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .status-badge.abwesend {
            background: rgba(255,255,255,0.2);
        }

        .refresh-notice {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            padding: 15px;
            text-align: center;
            font-size: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .refresh-notice .live-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .loading {
            text-align: center;
            padding: 50px;
            opacity: 0.5;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.5;
        }

        .empty-state .icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üìã Nachlieferungs-Reihenfolge</h1>
        <div class="subtitle">Gunterswiler AG</div>
        <div class="time" id="clock">--:--</div>
    </header>

    <!-- Alert Banner f√ºr neue Zuweisung -->
    <div class="alert-banner" id="alertBanner">
        <div class="alert-title">üö® Neue Nachlieferung!</div>
        <div class="alert-content" id="alertContent"></div>
    </div>

    <div class="ranking-list" id="rankingList">
        <div class="loading">Laden...</div>
    </div>

    <div class="refresh-notice">
        <span class="live-dot"></span>
        Live-Aktualisierung aktiv
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyAJIPZpX0ML_ahRqYGaysybxBHpbWKYspI",
            authDomain: "infozentrale-7b690.firebaseapp.com",
            projectId: "infozentrale-7b690",
            storageBucket: "infozentrale-7b690.firebasestorage.app",
            messagingSenderId: "634159156585",
            appId: "1:634159156585:web:deb48910b3f42d4e5081f8",
            measurementId: "G-LXS5T04D2F"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let lastKundenState = {};

        // ==================== RENDER ====================
        function renderRangliste(rangliste) {
            const list = document.getElementById('rankingList');
            
            if (!rangliste || rangliste.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <p>Keine Daten vorhanden</p>
                    </div>
                `;
                return;
            }

            // Filter: Nur Chauffeure die Nachlieferungen machen
            const activeRangliste = rangliste.filter(item => !item.excluded);
            
            // Check f√ºr neue Kunden-Zuweisungen
            checkForNewKunden(activeRangliste);
            
            list.innerHTML = activeRangliste.map((item, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                const abwesendClass = item.abwesend ? 'abwesend' : '';
                const hasKundeClass = item.kunde ? 'has-kunde' : '';
                
                let statusBadge = '';
                if (item.abwesend) {
                    statusBadge = '<span class="status-badge abwesend">üè† Abwesend</span>';
                }
                
                const kundeHtml = item.kunde ? `
                    <div class="kunde-info">
                        <div class="label">Nachlieferung an:</div>
                        <div class="kunde-name">üö® ${item.kunde}</div>
                    </div>
                ` : '';
                
                return `
                    <div class="ranking-card ${rankClass} ${abwesendClass} ${hasKundeClass}">
                        <span class="rank-badge">${index + 1}</span>
                        <div class="ranking-info">
                            <div class="driver-name">${item.fahrer}</div>
                            ${kundeHtml}
                        </div>
                        ${statusBadge}
                    </div>
                `;
            }).join('');
        }

        function checkForNewKunden(rangliste) {
            const alertBanner = document.getElementById('alertBanner');
            const alertContent = document.getElementById('alertContent');
            
            rangliste.forEach((item, index) => {
                const key = item.fahrer;
                const hadKunde = lastKundenState[key];
                const hasKunde = item.kunde;
                
                // Neue Zuweisung erkannt
                if (hasKunde && hasKunde !== hadKunde) {
                    alertContent.textContent = `${item.fahrer} ‚Üí ${item.kunde}`;
                    alertBanner.classList.add('show');
                    
                    // Vibration wenn unterst√ºtzt
                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }
                    
                    // Banner nach 10 Sekunden ausblenden
                    setTimeout(() => {
                        alertBanner.classList.remove('show');
                    }, 10000);
                }
                
                lastKundenState[key] = hasKunde;
            });
        }

        // ==================== FIREBASE LISTENER ====================
        function setupRealtimeListener() {
            db.collection('settings').doc('rangliste').onSnapshot((doc) => {
                if (doc.exists) {
                    renderRangliste(doc.data().list || []);
                }
            });
        }

        // ==================== UHR ====================
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').textContent = time;
        }

        // ==================== INIT ====================
        setupRealtimeListener();
        updateClock();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>
