<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gunterswiler AG - Info-Zentrale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }

        .header {
            background: rgba(255,255,255,0.1);
            padding: 8px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4ade80;
            height: 60px;
        }

        .logo {
            font-size: 22px;
            font-weight: bold;
            color: #4ade80;
        }

        .logo span {
            color: #fff;
        }

        .logo-subtitle {
            font-size: 11px;
            font-weight: normal;
            opacity: 0.7;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .weather {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.08);
            padding: 10px 20px;
            border-radius: 12px;
        }

        .weather-icon { font-size: 40px; }
        .weather-info { text-align: left; }
        .weather-temp { font-size: 26px; font-weight: 600; }
        .weather-desc { font-size: 12px; opacity: 0.7; }

        .weather-forecast {
            display: flex;
            gap: 12px;
            margin-left: 15px;
            padding-left: 20px;
            border-left: 1px solid rgba(255,255,255,0.2);
        }

        .forecast-item { text-align: center; font-size: 12px; opacity: 0.7; }
        .forecast-item .temp { font-size: 14px; font-weight: 600; opacity: 1; }

        .mode-indicator {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
        }

        .mode-indicator .mode-name {
            font-weight: 600;
            color: #4ade80;
        }

        .header-right { text-align: right; }
        .clock { font-size: 32px; font-weight: 300; letter-spacing: 2px; }
        .date { font-size: 12px; opacity: 0.7; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 60px);
        }

        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .section-title .icon {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* ==================== TOUREN SECTION ==================== */
        .tours-section .icon { background: #3b82f6; }

        .tour-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 12px;
            flex: 1;
        }

        .tour-card {
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: transform 0.2s;
            position: relative;
        }

        .tour-card:hover { transform: scale(1.02); }

        .tour-card.status-kommissionieren {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.5), rgba(185, 28, 28, 0.5));
            border: 3px solid #ef4444;
        }

        .tour-card.status-ready {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(22, 163, 74, 0.5));
            border: 3px solid #22c55e;
        }

        .tour-card.status-unterwegs {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), rgba(37, 99, 235, 0.5));
            border: 3px solid #3b82f6;
        }

        .tour-card.empty {
            background: rgba(255,255,255,0.02);
            border: 2px dashed rgba(255,255,255,0.1);
        }

        .tour-name { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .driver-name { font-size: 16px; opacity: 0.9; }

        .tour-status-badge {
            margin-top: 10px;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-kommissionieren { background: #ef4444; color: #fff; }
        .badge-ready { background: #22c55e; color: #fff; }
        .badge-unterwegs { background: #3b82f6; color: #fff; }

        .lieferschein-notice {
            margin-top: 10px;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            background: rgba(0,0,0,0.4);
            padding: 8px 15px;
            border-radius: 10px;
            animation: pulse-notice 1.5s infinite;
            text-transform: uppercase;
        }

        @keyframes pulse-notice {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ==================== RANGLISTE SECTION (GROSS) ==================== */
        .ranking-section .icon { background: #f59e0b; }

        .ranking-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .ranking-card {
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            transition: all 0.3s;
        }

        .ranking-card.rank-1 {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.4), rgba(217, 119, 6, 0.4));
            border: 3px solid #f59e0b;
        }

        .ranking-card.rank-2 {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.3), rgba(107, 114, 128, 0.3));
            border: 3px solid #9ca3af;
        }

        .ranking-card.rank-3 {
            background: linear-gradient(135deg, rgba(180, 83, 9, 0.3), rgba(146, 64, 14, 0.3));
            border: 3px solid #b45309;
        }

        .ranking-card.rank-other {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .ranking-card.abwesend {
            opacity: 0.4;
            border-style: dashed;
        }

        .ranking-card.has-kunde {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
            50% { box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.5); }
        }

        .rank-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .rank-1 .rank-badge { background: #f59e0b; color: #000; }
        .rank-2 .rank-badge { background: #9ca3af; color: #000; }
        .rank-3 .rank-badge { background: #b45309; color: #fff; }
        .rank-other .rank-badge { background: rgba(255,255,255,0.1); }

        .ranking-info { flex: 1; }
        .ranking-info .driver-name { font-size: 24px; font-weight: 600; }
        
        .kunde-info {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }

        .kunde-info .label { font-size: 11px; opacity: 0.7; text-transform: uppercase; }
        .kunde-info .kunde-name { font-size: 16px; font-weight: 600; }

        .abwesend-badge {
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 8px;
        }

        /* ==================== NEWS SECTION ==================== */
        .news-section .icon { background: #ec4899; }

        .news-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .news-card {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .news-card.birthday {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(168, 85, 247, 0.2));
            border-color: rgba(236, 72, 153, 0.3);
        }

        .news-card.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(34, 211, 238, 0.2));
            border-color: rgba(59, 130, 246, 0.3);
        }

        .news-card.product {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.2));
            border-color: rgba(74, 222, 128, 0.3);
        }

        .news-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .news-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }

        .news-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            width: fit-content;
        }

        .badge-birthday { background: #ec4899; }
        .badge-info { background: #3b82f6; }
        .badge-product { background: #4ade80; color: #000; }

        .news-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .news-text { font-size: 14px; opacity: 0.8; line-height: 1.4; }

        .news-card.empty {
            background: rgba(255,255,255,0.02);
            border: 1px dashed rgba(255,255,255,0.1);
            align-items: center;
            justify-content: center;
        }

        .news-card.empty .placeholder-text { opacity: 0.3; font-size: 14px; }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            opacity: 0.5;
            font-size: 18px;
        }

        /* Hide sections based on mode */
        .main-section { display: none; }
        .main-section.active { display: flex; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            GUNTERSWILER <span>AG</span>
            <div class="logo-subtitle">Info-Zentrale</div>
        </div>

        <div class="header-center">
            <div class="weather">
                <span class="weather-icon" id="weatherIcon">‚õÖ</span>
                <div class="weather-info">
                    <div class="weather-temp" id="weatherTemp">--¬∞C</div>
                    <div class="weather-desc" id="weatherDesc">Laden...</div>
                </div>
                <div class="weather-forecast" id="weatherForecast"></div>
            </div>

            <div class="mode-indicator">
                <span id="modeLabel">Modus:</span> <span class="mode-name" id="modeName">Laden...</span>
            </div>
        </div>

        <div class="header-right">
            <div class="clock" id="clock">--:--</div>
            <div class="date" id="date">Laden...</div>
        </div>
    </header>

    <main class="main-content">
        <!-- TOUREN SECTION (12:00 - 07:30) -->
        <section class="section tours-section main-section" id="tourenSection">
            <h2 class="section-title">
                <span class="icon">üöö</span>
                Touren Status
            </h2>
            <div class="tour-grid" id="tourGrid">
                <div class="loading">Laden...</div>
            </div>
        </section>

        <!-- RANGLISTE SECTION (07:30 - 12:00) -->
        <section class="section ranking-section main-section" id="ranglisteSection">
            <h2 class="section-title">
                <span class="icon">üìã</span>
                Nachlieferungs-Reihenfolge
            </h2>
            <div class="ranking-grid" id="rankingGrid">
                <div class="loading">Laden...</div>
            </div>
        </section>

        <!-- NEWS (immer sichtbar) -->
        <section class="section news-section">
            <h2 class="section-title">
                <span class="icon">üì¢</span>
                News & Infos
            </h2>
            <div class="news-grid" id="newsGrid">
                <div class="loading">Laden...</div>
            </div>
        </section>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyAJIPZpX0ML_ahRqYGaysybxBHpbWKYspI",
            authDomain: "infozentrale-7b690.firebaseapp.com",
            projectId: "infozentrale-7b690",
            storageBucket: "infozentrale-7b690.firebasestorage.app",
            messagingSenderId: "634159156585",
            appId: "1:634159156585:web:deb48910b3f42d4e5081f8",
            measurementId: "G-LXS5T04D2F"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const TOUR_NAMEN = [
            "Aadorf", "Uster", "Weinfelden", "Winterthur", "Schaffhausen",
            "Frauenfeld Fr√ºh", "Test", "Nahe Umgebung", "Klettgau",
            "Stein am Rhein", "Frauenfeld Sp√§t"
        ];

        // ==================== MODE SWITCHING ====================
        function getCurrentMode() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const currentTime = hours * 60 + minutes;
            
            const startNachlieferung = 7 * 60 + 30;  // 07:30
            const endNachlieferung = 12 * 60;        // 12:00
            
            if (currentTime >= startNachlieferung && currentTime < endNachlieferung) {
                return 'nachlieferung';
            }
            return 'touren';
        }

        function updateMode() {
            const mode = getCurrentMode();
            const tourenSection = document.getElementById('tourenSection');
            const ranglisteSection = document.getElementById('ranglisteSection');
            const modeName = document.getElementById('modeName');
            
            if (mode === 'nachlieferung') {
                tourenSection.classList.remove('active');
                ranglisteSection.classList.add('active');
                modeName.textContent = 'üìã Nachlieferungen (07:30-12:00)';
            } else {
                tourenSection.classList.add('active');
                ranglisteSection.classList.remove('active');
                modeName.textContent = 'üöö Touren Status';
            }
        }

        // ==================== RENDER TOUREN ====================
        function renderTouren(touren) {
            const grid = document.getElementById('tourGrid');
            let html = '';
            
            for (let i = 0; i < 12; i++) {
                const tour = touren[i];
                
                if (tour && tour.name) {
                    const statusClass = `status-${tour.status}`;
                    const badgeClass = `badge-${tour.status}`;
                    const statusText = tour.status === 'kommissionieren' ? 'Kommissionieren' :
                                      tour.status === 'ready' ? 'READY' : 'Unterwegs';
                    
                    const lieferscheinHtml = tour.status === 'ready' 
                        ? '<div class="lieferschein-notice">üìÑ Lieferscheine bereit</div>' 
                        : '';
                    
                    html += `
                        <div class="tour-card ${statusClass}">
                            <div class="tour-name">${tour.name}</div>
                            <div class="driver-name">${tour.fahrer || '-'}</div>
                            <span class="tour-status-badge ${badgeClass}">${statusText}</span>
                            ${lieferscheinHtml}
                        </div>
                    `;
                } else {
                    html += `<div class="tour-card empty"></div>`;
                }
            }
            
            grid.innerHTML = html;
        }

        // ==================== RENDER RANGLISTE ====================
        function renderRangliste(rangliste) {
            const grid = document.getElementById('rankingGrid');
            
            if (!rangliste || rangliste.length === 0) {
                grid.innerHTML = '<div class="loading">Keine Daten</div>';
                return;
            }

            // Filter: Nur Chauffeure die Nachlieferungen machen
            const activeRangliste = rangliste.filter(item => !item.excluded);
            
            grid.innerHTML = activeRangliste.map((item, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                const abwesendClass = item.abwesend ? 'abwesend' : '';
                const hasKundeClass = item.kunde ? 'has-kunde' : '';
                const abwesendBadge = item.abwesend ? '<span class="abwesend-badge">üè† Abwesend</span>' : '';
                
                const kundeHtml = item.kunde ? `
                    <div class="kunde-info">
                        <div class="label">Nachlieferung an:</div>
                        <div class="kunde-name">üö® ${item.kunde}</div>
                    </div>
                ` : '';
                
                return `
                    <div class="ranking-card ${rankClass} ${abwesendClass} ${hasKundeClass}">
                        <span class="rank-badge">${index + 1}</span>
                        <div class="ranking-info">
                            <div class="driver-name">${item.fahrer}</div>
                            ${kundeHtml}
                        </div>
                        ${abwesendBadge}
                    </div>
                `;
            }).join('');
        }

        // ==================== RENDER NEWS ====================
        function renderNews(news) {
            const grid = document.getElementById('newsGrid');
            let html = '';
            
            if (!news) news = [];
            
            for (let i = 0; i < 2; i++) {
                const item = news[i];
                
                if (item) {
                    const imageContent = item.emoji || 'üì¢';
                    
                    html += `
                        <div class="news-card ${item.typ}">
                            <div class="news-image">${imageContent}</div>
                            <div class="news-content">
                                <span class="news-badge badge-${item.typ}">${item.typ}</span>
                                <div class="news-title">${item.titel}</div>
                                <div class="news-text">${item.text}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="news-card empty">
                            <span class="placeholder-text">Keine News</span>
                        </div>
                    `;
                }
            }
            
            grid.innerHTML = html;
        }

        // ==================== FIREBASE LISTENERS ====================
        function setupRealtimeListeners() {
            db.collection('settings').doc('touren').onSnapshot((doc) => {
                if (doc.exists) {
                    renderTouren(doc.data().list || []);
                }
            });

            db.collection('settings').doc('rangliste').onSnapshot((doc) => {
                if (doc.exists) {
                    renderRangliste(doc.data().list || []);
                }
            });

            db.collection('settings').doc('news').onSnapshot((doc) => {
                if (doc.exists) {
                    renderNews(doc.data().list || []);
                }
            });
        }

        // ==================== UHR & WETTER ====================
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString('de-CH', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
            document.getElementById('clock').textContent = time;
            document.getElementById('date').textContent = date;
            updateMode();
        }

        async function loadWeather() {
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=47.55&longitude=8.90&current=temperature_2m,weather_code&hourly=temperature_2m&timezone=Europe/Zurich&forecast_days=1`
                );
                const data = await response.json();
                
                document.getElementById('weatherTemp').textContent = `${Math.round(data.current.temperature_2m)}¬∞C`;
                document.getElementById('weatherIcon').textContent = getWeatherIcon(data.current.weather_code);
                document.getElementById('weatherDesc').textContent = getWeatherDescription(data.current.weather_code);
                
                const now = new Date();
                const currentHour = now.getHours();
                const forecastHours = [currentHour + 2, currentHour + 4, currentHour + 6].map(h => h % 24);
                
                document.getElementById('weatherForecast').innerHTML = forecastHours.map(hour => `
                    <div class="forecast-item">
                        <div>${hour.toString().padStart(2, '0')}:00</div>
                        <div class="temp">${Math.round(data.hourly.temperature_2m[hour])}¬∞</div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('weatherDesc').textContent = 'Nicht verf√ºgbar';
            }
        }

        function getWeatherIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 49) return 'üå´Ô∏è';
            if (code <= 69) return 'üåßÔ∏è';
            if (code <= 79) return 'üå®Ô∏è';
            return '‚õàÔ∏è';
        }

        function getWeatherDescription(code) {
            if (code === 0) return 'Sonnig';
            if (code <= 3) return 'Teilweise bew√∂lkt';
            if (code <= 49) return 'Nebel';
            if (code <= 69) return 'Regen';
            if (code <= 79) return 'Schnee';
            return 'Gewitter';
        }

        // ==================== INIT ====================
        setupRealtimeListeners();
        updateClock();
        loadWeather();
        setInterval(updateClock, 1000);
        setInterval(loadWeather, 600000);
    </script>
</body>
</html>
