<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gunterswiler AG - Info-Zentrale</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); height: 100vh; color: #fff; overflow: hidden; }
        
        .header { background: rgba(255,255,255,0.1); padding: 8px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #4ade80; height: 60px; }
        .logo { font-size: 22px; font-weight: bold; color: #4ade80; }
        .logo span { color: #fff; }
        .logo-subtitle { font-size: 11px; font-weight: normal; opacity: 0.7; }
        .header-center { display: flex; align-items: center; gap: 30px; }
        .weather { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.08); padding: 10px 20px; border-radius: 12px; }
        .weather-icon { font-size: 40px; }
        .weather-info { text-align: left; }
        .weather-temp { font-size: 26px; font-weight: 600; }
        .weather-desc { font-size: 12px; opacity: 0.7; }
        .weather-forecast { display: flex; gap: 12px; margin-left: 15px; padding-left: 20px; border-left: 1px solid rgba(255,255,255,0.2); }
        .forecast-item { text-align: center; font-size: 12px; opacity: 0.7; }
        .forecast-item .temp { font-size: 14px; font-weight: 600; opacity: 1; }
        .mode-indicator { background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 8px; font-size: 12px; }
        .mode-indicator .mode-name { font-weight: 600; color: #4ade80; }
        .header-right { text-align: right; }
        .clock { font-size: 32px; font-weight: 300; letter-spacing: 2px; }
        .date { font-size: 12px; opacity: 0.7; }

        .main-content { display: none; gap: 15px; padding: 15px; height: calc(100vh - 60px); }
        .main-content.active { display: grid; }
        .layout-touren { grid-template-columns: 1fr 350px; }
        .layout-nachlieferung { grid-template-columns: 1fr 1fr 300px; }

        .section { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .section-title .icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; }

        .tours-section .icon { background: #3b82f6; }
        .tour-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(3, 1fr); gap: 12px; flex: 1; }
        .tour-card { border-radius: 12px; padding: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: transform 0.2s; }
        .tour-card:hover { transform: scale(1.02); }
        .tour-card.status-kommissionieren { background: linear-gradient(135deg, rgba(239, 68, 68, 0.5), rgba(185, 28, 28, 0.5)); border: 3px solid #ef4444; }
        .tour-card.status-ready { background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(22, 163, 74, 0.5)); border: 3px solid #22c55e; }
        .tour-card.status-unterwegs { background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), rgba(37, 99, 235, 0.5)); border: 3px solid #3b82f6; }
        .tour-card.status-erledigt { background: linear-gradient(135deg, rgba(107, 114, 128, 0.3), rgba(75, 85, 99, 0.3)); border: 3px solid #6b7280; }
        .tour-card.empty { background: rgba(255,255,255,0.02); border: 2px dashed rgba(255,255,255,0.1); }
        .tour-name { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .driver-name { font-size: 22px; opacity: 0.95; margin-bottom: 10px; }
        .tour-status-badge { margin-top: 8px; padding: 8px 20px; border-radius: 20px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .badge-kommissionieren { background: #ef4444; color: #fff; }
        .badge-ready { background: #22c55e; color: #fff; }
        .badge-unterwegs { background: #3b82f6; color: #fff; }
        .badge-erledigt { background: #6b7280; color: #fff; }
        .lieferschein-notice { margin-top: 12px; font-size: 16px; font-weight: 700; color: #fff; background: rgba(0,0,0,0.4); padding: 10px 18px; border-radius: 12px; animation: pulse-notice 1.5s infinite; text-transform: uppercase; }
        @keyframes pulse-notice { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .ranking-section .icon { background: #f59e0b; }
        .ranking-grid { display: flex; flex-direction: column; gap: 8px; flex: 1; overflow-y: auto; }
        .ranking-card { border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 15px; transition: all 0.3s; }
        .ranking-card.rank-1 { background: linear-gradient(135deg, rgba(245, 158, 11, 0.4), rgba(217, 119, 6, 0.4)); border: 2px solid #f59e0b; }
        .ranking-card.rank-2 { background: linear-gradient(135deg, rgba(156, 163, 175, 0.3), rgba(107, 114, 128, 0.3)); border: 2px solid #9ca3af; }
        .ranking-card.rank-3 { background: linear-gradient(135deg, rgba(180, 83, 9, 0.3), rgba(146, 64, 14, 0.3)); border: 2px solid #b45309; }
        .ranking-card.rank-other { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); }
        .ranking-card.abwesend { opacity: 0.4; border-style: dashed; }
        .rank-badge { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; flex-shrink: 0; }
        .rank-1 .rank-badge { background: #f59e0b; color: #000; }
        .rank-2 .rank-badge { background: #9ca3af; color: #000; }
        .rank-3 .rank-badge { background: #b45309; color: #fff; }
        .rank-other .rank-badge { background: rgba(255,255,255,0.1); }
        .ranking-info { flex: 1; }
        .ranking-info .ranking-driver-name { font-size: 20px; font-weight: 600; }
        .kunde-info { margin-top: 6px; padding: 6px 10px; background: rgba(239, 68, 68, 0.3); border-radius: 6px; border-left: 3px solid #ef4444; font-size: 13px; }
        .kunde-info .kunde-name { font-weight: 600; }
        .abwesend-badge { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; }

        .unterwegs-section .icon { background: #3b82f6; }
        .unterwegs-grid { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
        .unterwegs-card { background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(37, 99, 235, 0.4)); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 20px; }
        .unterwegs-card .tour-icon { font-size: 30px; }
        .unterwegs-card .tour-info { flex: 1; }
        .unterwegs-card .tour-name { font-size: 22px; font-weight: 700; }
        .unterwegs-card .driver-name { font-size: 16px; opacity: 0.9; }
        .unterwegs-card .status-badge { background: #3b82f6; padding: 6px 15px; border-radius: 15px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        
        .feierabend-message { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .feierabend-message .icon { font-size: 80px; margin-bottom: 20px; }
        .feierabend-message h2 { font-size: 32px; color: #4ade80; margin-bottom: 10px; }
        .feierabend-message p { font-size: 18px; opacity: 0.7; }

        .news-section .icon { background: #ec4899; }
        .news-grid { display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .news-card { flex: 1; background: rgba(255,255,255,0.08); border-radius: 10px; padding: 12px; display: flex; gap: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .news-card.birthday { background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(168, 85, 247, 0.2)); border-color: rgba(236, 72, 153, 0.3); }
        .news-card.info { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(34, 211, 238, 0.2)); border-color: rgba(59, 130, 246, 0.3); }
        .news-card.product { background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.2)); border-color: rgba(74, 222, 128, 0.3); }
        .news-image { width: 60px; height: 60px; border-radius: 8px; background: rgba(255,255,255,0.1); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 30px; overflow: hidden; }
        .news-image img { width: 100%; height: 100%; object-fit: cover; }
        .news-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .news-badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; width: fit-content; }
        .badge-birthday { background: #ec4899; }
        .badge-info { background: #3b82f6; }
        .badge-product { background: #4ade80; color: #000; }
        .news-title { font-size: 15px; font-weight: 600; margin-bottom: 3px; }
        .news-text { font-size: 12px; opacity: 0.8; line-height: 1.3; }
        .news-card.empty { background: rgba(255,255,255,0.02); border: 1px dashed rgba(255,255,255,0.1); align-items: center; justify-content: center; }
        .news-card.empty .placeholder-text { opacity: 0.3; font-size: 12px; }
        .loading { display: flex; align-items: center; justify-content: center; height: 100%; opacity: 0.5; font-size: 16px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">GUNTERSWILER <span>AG</span><div class="logo-subtitle">Info-Zentrale</div></div>
        <div class="header-center">
            <div class="weather">
                <span class="weather-icon" id="weatherIcon">‚õÖ</span>
                <div class="weather-info">
                    <div class="weather-temp" id="weatherTemp">--¬∞C</div>
                    <div class="weather-desc" id="weatherDesc">Laden...</div>
                </div>
                <div class="weather-forecast" id="weatherForecast"></div>
            </div>
            <div class="mode-indicator">Modus: <span class="mode-name" id="modeName">Laden...</span></div>
        </div>
        <div class="header-right">
            <div class="clock" id="clock">--:--</div>
            <div class="date" id="date">Laden...</div>
        </div>
    </header>

    <main class="main-content layout-touren" id="layoutTouren">
        <section class="section tours-section">
            <h2 class="section-title"><span class="icon">üöö</span>Touren Status</h2>
            <div class="tour-grid" id="tourGrid"><div class="loading">Laden...</div></div>
        </section>
        <section class="section news-section">
            <h2 class="section-title"><span class="icon">üì¢</span>News & Infos</h2>
            <div class="news-grid" id="newsGridTouren"><div class="loading">Laden...</div></div>
        </section>
    </main>

    <main class="main-content layout-nachlieferung" id="layoutNachlieferung">
        <section class="section ranking-section">
            <h2 class="section-title"><span class="icon">üìã</span>Nachlieferungs-Reihenfolge</h2>
            <div class="ranking-grid" id="rankingGrid"><div class="loading">Laden...</div></div>
        </section>
        <section class="section unterwegs-section">
            <h2 class="section-title"><span class="icon">üöö</span>Touren unterwegs</h2>
            <div class="unterwegs-grid" id="unterwegsGrid"><div class="loading">Laden...</div></div>
        </section>
        <section class="section news-section">
            <h2 class="section-title"><span class="icon">üì¢</span>News & Infos</h2>
            <div class="news-grid" id="newsGridNachlieferung"><div class="loading">Laden...</div></div>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAJIPZpX0ML_ahRqYGaysybxBHpbWKYspI",
            authDomain: "infozentrale-7b690.firebaseapp.com",
            projectId: "infozentrale-7b690",
            storageBucket: "infozentrale-7b690.firebasestorage.app",
            messagingSenderId: "634159156585",
            appId: "1:634159156585:web:deb48910b3f42d4e5081f8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function getCurrentMode() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            return (currentTime >= 450 && currentTime < 720) ? 'nachlieferung' : 'touren';
        }

        function updateMode() {
            const mode = getCurrentMode();
            document.getElementById('layoutTouren').classList.toggle('active', mode === 'touren');
            document.getElementById('layoutNachlieferung').classList.toggle('active', mode === 'nachlieferung');
            document.getElementById('modeName').textContent = mode === 'nachlieferung' ? 'üìã Nachlieferungen (07:30-12:00)' : 'üöö Touren Status';
        }

        function renderTouren(touren) {
            const grid = document.getElementById('tourGrid');
            let html = '';
            for (let i = 0; i < 12; i++) {
                const tour = touren[i];
                if (tour && tour.name) {
                    const statusClass = `status-${tour.status}`;
                    const badgeClass = `badge-${tour.status}`;
                    const statusText = tour.status === 'kommissionieren' ? 'KOMMISSIONIEREN' : tour.status === 'ready' ? 'READY' : tour.status === 'unterwegs' ? 'UNTERWEGS' : 'ERLEDIGT';
                    const lieferscheinHtml = tour.status === 'ready' ? '<div class="lieferschein-notice">üìÑ Lieferscheine bereit</div>' : '';
                    html += `<div class="tour-card ${statusClass}"><div class="tour-name">${tour.name}</div><div class="driver-name">${tour.fahrer || '-'}</div><span class="tour-status-badge ${badgeClass}">${statusText}</span>${lieferscheinHtml}</div>`;
                } else {
                    html += `<div class="tour-card empty"></div>`;
                }
            }
            grid.innerHTML = html;
            renderUnterwegsTouren(touren);
        }

        function renderUnterwegsTouren(touren) {
            const grid = document.getElementById('unterwegsGrid');
            const unterwegs = touren.filter(t => t && t.status === 'unterwegs');
            
            if (unterwegs.length === 0) {
                grid.innerHTML = `<div class="feierabend-message"><div class="icon">üéâ</div><h2>Sch√∂nen Feierabend!</h2><p>Alle Touren sind erledigt.</p></div>`;
                return;
            }

            grid.innerHTML = unterwegs.map(tour => `
                <div class="unterwegs-card">
                    <div class="tour-icon">üöö</div>
                    <div class="tour-info">
                        <div class="tour-name">${tour.name}</div>
                        <div class="driver-name">${tour.fahrer || '-'}</div>
                    </div>
                    <span class="status-badge">UNTERWEGS</span>
                </div>
            `).join('');
        }

        function renderRangliste(rangliste) {
            const grid = document.getElementById('rankingGrid');
            if (!rangliste || rangliste.length === 0) { grid.innerHTML = '<div class="loading">Keine Daten</div>'; return; }
            const activeRangliste = rangliste.filter(item => !item.excluded);
            grid.innerHTML = activeRangliste.map((item, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                const abwesendClass = item.abwesend ? 'abwesend' : '';
                const abwesendBadge = item.abwesend ? '<span class="abwesend-badge">üè† Abwesend</span>' : '';
                const kundeHtml = item.kunde ? `<div class="kunde-info"><span class="kunde-name">üö® ${item.kunde}</span></div>` : '';
                return `<div class="ranking-card ${rankClass} ${abwesendClass}"><span class="rank-badge">${index + 1}</span><div class="ranking-info"><div class="ranking-driver-name">${item.fahrer}</div>${kundeHtml}</div>${abwesendBadge}</div>`;
            }).join('');
        }

        function renderNews(news, containerId) {
            const grid = document.getElementById(containerId);
            let html = '';
            if (!news) news = [];
            for (let i = 0; i < 2; i++) {
                const item = news[i];
                if (item) {
                    const imageContent = item.bild ? `<img src="${item.bild}" alt="">` : (item.emoji || 'üì¢');
                    html += `<div class="news-card ${item.typ}"><div class="news-image">${imageContent}</div><div class="news-content"><span class="news-badge badge-${item.typ}">${item.typ}</span><div class="news-title">${item.titel}</div><div class="news-text">${item.text}</div></div></div>`;
                } else {
                    html += `<div class="news-card empty"><span class="placeholder-text">Keine News</span></div>`;
                }
            }
            grid.innerHTML = html;
        }

        function setupRealtimeListeners() {
            db.collection('settings').doc('touren').onSnapshot(doc => { if (doc.exists) renderTouren(doc.data().list || []); });
            db.collection('settings').doc('rangliste').onSnapshot(doc => { if (doc.exists) renderRangliste(doc.data().list || []); });
            db.collection('settings').doc('news').onSnapshot(doc => { 
                if (doc.exists) {
                    renderNews(doc.data().list || [], 'newsGridTouren');
                    renderNews(doc.data().list || [], 'newsGridNachlieferung');
                }
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('date').textContent = now.toLocaleDateString('de-CH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            updateMode();
        }

        async function loadWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=47.55&longitude=8.90&current=temperature_2m,weather_code&hourly=temperature_2m&timezone=Europe/Zurich&forecast_days=1');
                const data = await response.json();
                document.getElementById('weatherTemp').textContent = `${Math.round(data.current.temperature_2m)}¬∞C`;
                const code = data.current.weather_code;
                document.getElementById('weatherIcon').textContent = code === 0 ? '‚òÄÔ∏è' : code <= 3 ? '‚õÖ' : code <= 49 ? 'üå´Ô∏è' : code <= 69 ? 'üåßÔ∏è' : code <= 79 ? 'üå®Ô∏è' : '‚õàÔ∏è';
                document.getElementById('weatherDesc').textContent = code === 0 ? 'Sonnig' : code <= 3 ? 'Teilweise bew√∂lkt' : code <= 49 ? 'Nebel' : code <= 69 ? 'Regen' : code <= 79 ? 'Schnee' : 'Gewitter';
                const currentHour = new Date().getHours();
                const forecastHours = [currentHour + 2, currentHour + 4, currentHour + 6].map(h => h % 24);
                document.getElementById('weatherForecast').innerHTML = forecastHours.map(hour => `<div class="forecast-item"><div>${hour.toString().padStart(2, '0')}:00</div><div class="temp">${Math.round(data.hourly.temperature_2m[hour])}¬∞</div></div>`).join('');
            } catch (e) { document.getElementById('weatherDesc').textContent = 'Nicht verf√ºgbar'; }
        }

        setupRealtimeListeners();
        updateClock();
        loadWeather();
        setInterval(updateClock, 1000);
        setInterval(loadWeather, 600000);
    </script>
</body>
</html>
