<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info-Zentrale - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; }
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%; }
        .login-box h1 { color: #1a1a2e; margin-bottom: 10px; }
        .login-box p { color: #666; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; text-align: center; letter-spacing: 8px; margin-bottom: 20px; }
        .login-box input:focus { outline: none; border-color: #4ade80; }
        .login-box button { width: 100%; padding: 15px; font-size: 16px; background: #4ade80; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .login-box button:hover { background: #22c55e; }
        .login-error { color: #ef4444; margin-top: 15px; display: none; }
        .admin-panel { display: none; }
        .admin-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .admin-header h1 { font-size: 20px; color: #4ade80; }
        .admin-header h1 span { color: white; font-weight: normal; }
        .header-links { display: flex; gap: 15px; align-items: center; }
        .header-links a { color: #4ade80; text-decoration: none; font-size: 13px; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 6px; }
        .header-links a:hover { background: rgba(255,255,255,0.2); }
        .sync-status { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .sync-dot { width: 10px; height: 10px; border-radius: 50%; background: #4ade80; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .logout-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }
        .admin-content { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; border: none; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-btn:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .tab-btn.active { background: #4ade80; color: #000; }
        .tab-content { display: none; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .tab-content h2 { margin-bottom: 20px; color: #1a1a2e; font-size: 18px; }
        .info-text { margin-bottom: 15px; color: #666; font-size: 14px; }
        .touren-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .tour-edit-card { background: #f9f9f9; border-radius: 10px; padding: 15px; border: 2px solid #e5e5e5; }
        .tour-edit-card h3 { font-size: 16px; margin-bottom: 12px; color: #1a1a2e; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-group select, .form-group input[type="text"], .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #4ade80; }
        .status-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .status-btn { padding: 10px 8px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; text-align: center; background: white; }
        .status-btn.kommissionieren.active { background: #ef4444; border-color: #ef4444; color: white; }
        .status-btn.ready.active { background: #22c55e; border-color: #22c55e; color: white; }
        .status-btn.unterwegs.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .status-btn.erledigt.active { background: #6b7280; border-color: #6b7280; color: white; }
        .rangliste-container { max-width: 700px; }
        .rangliste-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e5e5e5; flex-wrap: wrap; }
        .rangliste-item.abwesend { opacity: 0.5; background: #fee2e2; }
        .rangliste-item.has-kunde { border-color: #ef4444; background: #fef2f2; }
        .rang-nummer { width: 35px; height: 35px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; flex-shrink: 0; }
        .rangliste-info { flex: 1; min-width: 120px; }
        .rangliste-info strong { display: block; font-size: 16px; }
        .kunde-input { flex: 2; min-width: 180px; }
        .kunde-input input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .kunde-input input:focus { outline: none; border-color: #ef4444; }
        .rangliste-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .rangliste-actions button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px; background: white; white-space: nowrap; }
        .rangliste-actions button:hover { background: #f0f0f0; }
        .rangliste-actions button.move-down { background: #4ade80; border-color: #4ade80; color: #000; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px; width: 100%; }
        .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer; }
        .checkbox-label input { width: 16px; height: 16px; cursor: pointer; }
        .news-form { max-width: 500px; margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 10px; }
        .news-form h3 { margin-bottom: 15px; }
        .news-list { display: flex; flex-direction: column; gap: 10px; }
        .news-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 2px solid #e5e5e5; }
        .news-item .emoji { font-size: 32px; }
        .news-item .preview-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .news-item .info { flex: 1; }
        .news-item .info strong { display: block; }
        .news-item .info small { color: #666; }
        .delete-btn { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        .delete-btn:hover { background: #dc2626; }
        .chauffeure-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
        .chauffeur-input { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .chauffeur-input span { min-width: 30px; font-weight: 600; }
        .chauffeur-input input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .chauffeur-input .checkbox-label { margin-left: auto; white-space: nowrap; font-size: 11px; }
        .save-btn { background: #4ade80; color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .save-btn:hover { background: #22c55e; }
        .reset-btn { background: #ef4444; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 14px; cursor: pointer; margin-left: 10px; }
        .reset-btn:hover { background: #dc2626; }
        .success-msg { position: fixed; top: 20px; right: 20px; background: #4ade80; color: #000; padding: 15px 25px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 1000; }
        .image-upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .image-upload-area:hover { border-color: #4ade80; background: #f9fff9; }
        .image-upload-area.has-image { border-style: solid; border-color: #4ade80; }
        .image-upload-area input { display: none; }
        .image-upload-area .preview { max-width: 100px; max-height: 100px; border-radius: 8px; margin-top: 10px; }
        .image-upload-area .upload-text { color: #666; font-size: 13px; }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üîê Admin Login</h1>
            <p>Gunterswiler Info-Zentrale</p>
            <input type="password" id="pinInput" placeholder="PIN" maxlength="4">
            <button onclick="checkLogin()">Einloggen</button>
            <p class="login-error" id="loginError">Falscher PIN!</p>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel">
        <header class="admin-header">
            <h1>GUNTERSWILER <span>Admin</span></h1>
            <div class="header-links">
                <a href="index.html" target="_blank">üì∫ TV-Ansicht</a>
                <a href="fahrer.html" target="_blank">üì± Fahrer-Ansicht</a>
            </div>
            <div class="sync-status"><span class="sync-dot"></span><span>Live</span></div>
            <button class="logout-btn" onclick="logout()">Abmelden</button>
        </header>

        <div class="admin-content">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="showTab('touren', this)">üöö Touren</button>
                <button class="tab-btn" onclick="showTab('rangliste', this)">üìã Nachlieferungen</button>
                <button class="tab-btn" onclick="showTab('news', this)">üì¢ News</button>
                <button class="tab-btn" onclick="showTab('chauffeure', this)">üë§ Chauffeure</button>
            </div>

            <div class="tab-content active" id="tab-touren">
                <h2>Touren Status</h2>
                <p class="info-text">4 Status: Kommissionieren ‚Üí Ready ‚Üí Unterwegs ‚Üí Erledigt (Feierabend)</p>
                <div class="touren-grid" id="tourenGrid"></div>
                <button class="reset-btn" onclick="resetTouren()" style="margin-top:20px;">üîÑ Alle auf Kommissionieren</button>
            </div>

            <div class="tab-content" id="tab-rangliste">
                <h2>Nachlieferungs-Reihenfolge</h2>
                <p class="info-text">Sichtbar auf TV: 07:30 - 12:00 | Fahrer-Handy: /fahrer.html</p>
                <div class="rangliste-container" id="ranglisteContainer"></div>
            </div>

            <div class="tab-content" id="tab-news">
                <h2>News & Infos</h2>
                <div class="news-form">
                    <h3>Neue News</h3>
                    <div class="form-group">
                        <label>Typ</label>
                        <select id="newsTyp">
                            <option value="info">‚ÑπÔ∏è Info</option>
                            <option value="birthday">üéÇ Geburtstag</option>
                            <option value="product">üì¶ Produkt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" id="newsTitel" placeholder="z.B. Happy Birthday!">
                    </div>
                    <div class="form-group">
                        <label>Text</label>
                        <textarea id="newsText" rows="2" placeholder="z.B. Alles Gute, Sandra!"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Emoji (falls kein Bild)</label>
                        <input type="text" id="newsEmoji" placeholder="üéâ">
                    </div>
                    <div class="form-group">
                        <label>Bild (optional)</label>
                        <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('newsImage').click()">
                            <input type="file" id="newsImage" accept="image/*" onchange="handleImageUpload(this)">
                            <div class="upload-text">üì∑ Klicken zum Bild hochladen</div>
                            <img class="preview" id="imagePreview" style="display:none;">
                        </div>
                    </div>
                    <button class="save-btn" onclick="addNews()">‚ûï Hinzuf√ºgen</button>
                </div>
                <h3>Aktuelle News</h3>
                <div class="news-list" id="newsList"></div>
            </div>

            <div class="tab-content" id="tab-chauffeure">
                <h2>Chauffeure verwalten (15 Positionen)</h2>
                <p class="info-text">H√§kchen "Keine NL" = Chauffeur macht keine Nachlieferungen</p>
                <div class="chauffeure-grid" id="chauffeureGrid"></div>
                <button class="save-btn" onclick="saveChauffeure()">üíæ Speichern</button>
            </div>
        </div>
    </div>

    <div class="success-msg" id="successMsg">‚úÖ Gespeichert!</div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAJIPZpX0ML_ahRqYGaysybxBHpbWKYspI",
            authDomain: "infozentrale-7b690.firebaseapp.com",
            projectId: "infozentrale-7b690",
            storageBucket: "infozentrale-7b690.firebasestorage.app",
            messagingSenderId: "634159156585",
            appId: "1:634159156585:web:deb48910b3f42d4e5081f8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ADMIN_PIN = '1951';
        const TOUR_NAMEN = ["Aadorf", "Uster", "Weinfelden", "Winterthur", "Schaffhausen", "Frauenfeld Fr√ºh", "Test", "Nahe Umgebung", "Klettgau", "Stein am Rhein", "Frauenfeld Sp√§t"];
        const MAX_CHAUFFEURE = 15;

        let touren = [];
        let rangliste = [];
        let news = [];
        let chauffeure = [];
        let uploadedImageBase64 = '';

        function checkLogin() {
            if (document.getElementById('pinInput').value === ADMIN_PIN) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                initializeData();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('pinInput').value = '';
            }
        }

        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('pinInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        document.getElementById('pinInput').addEventListener('keypress', e => { if (e.key === 'Enter') checkLogin(); });

        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        async function initializeData() {
            const chauffeureDoc = await db.collection('settings').doc('chauffeure').get();
            if (chauffeureDoc.exists) {
                chauffeure = chauffeureDoc.data().list;
                if (typeof chauffeure[0] === 'string') {
                    chauffeure = chauffeure.map(c => ({ name: c, excluded: false }));
                }
            } else {
                chauffeure = Array.from({length: MAX_CHAUFFEURE}, (_, i) => ({ name: i < 12 ? `Chauffeur ${i + 1}` : '', excluded: false }));
            }
            while (chauffeure.length < MAX_CHAUFFEURE) {
                chauffeure.push({ name: '', excluded: false });
            }
            
            const tourenDoc = await db.collection('settings').doc('touren').get();
            touren = tourenDoc.exists ? tourenDoc.data().list : TOUR_NAMEN.map((name, i) => ({ name, fahrer: chauffeure[i]?.name || '', status: 'kommissionieren' }));
            
            const ranglisteDoc = await db.collection('settings').doc('rangliste').get();
            rangliste = ranglisteDoc.exists ? ranglisteDoc.data().list : chauffeure.filter(c => c.name && !c.excluded).map(c => ({ fahrer: c.name, abwesend: false, kunde: '', excluded: false }));
            
            const newsDoc = await db.collection('settings').doc('news').get();
            news = newsDoc.exists ? newsDoc.data().list || [] : [];

            renderAll();
        }

        function renderAll() {
            renderTouren();
            renderRangliste();
            renderNews();
            renderChauffeure();
        }

        function renderTouren() {
            document.getElementById('tourenGrid').innerHTML = touren.map((tour, i) => `
                <div class="tour-edit-card">
                    <h3>${tour.name}</h3>
                    <div class="form-group">
                        <label>Chauffeur</label>
                        <select onchange="updateTourFahrer(${i}, this.value)">
                            <option value="">-- Ausw√§hlen --</option>
                            ${chauffeure.filter(c => c.name).map(c => `<option value="${c.name}" ${tour.fahrer === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="status-buttons">
                            <button class="status-btn kommissionieren ${tour.status === 'kommissionieren' ? 'active' : ''}" onclick="updateTourStatus(${i}, 'kommissionieren')">üî¥ Kommiss.</button>
                            <button class="status-btn ready ${tour.status === 'ready' ? 'active' : ''}" onclick="updateTourStatus(${i}, 'ready')">üü¢ READY</button>
                            <button class="status-btn unterwegs ${tour.status === 'unterwegs' ? 'active' : ''}" onclick="updateTourStatus(${i}, 'unterwegs')">üîµ Unterwegs</button>
                            <button class="status-btn erledigt ${tour.status === 'erledigt' ? 'active' : ''}" onclick="updateTourStatus(${i}, 'erledigt')">‚úÖ Erledigt</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRangliste() {
            let position = 0;
            document.getElementById('ranglisteContainer').innerHTML = rangliste.map((item, i) => {
                if (item.excluded) return '';
                position++;
                const hasKundeClass = item.kunde ? 'has-kunde' : '';
                const abwesendClass = item.abwesend ? 'abwesend' : '';
                return `
                    <div class="rangliste-item ${hasKundeClass} ${abwesendClass}">
                        <span class="rang-nummer">${position}</span>
                        <div class="rangliste-info">
                            <strong>${item.fahrer}</strong>
                        </div>
                        <div class="kunde-input">
                            <input type="text" placeholder="Kunde f√ºr Nachlieferung..." value="${item.kunde || ''}" onchange="updateKunde(${i}, this.value)">
                        </div>
                        <div class="rangliste-actions">
                            <button class="move-down" onclick="moveToBottom(${i})">‚¨áÔ∏è Nach unten</button>
                        </div>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" ${item.abwesend ? 'checked' : ''} onchange="toggleAbwesend(${i})">
                                üè† Abwesend
                            </label>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderNews() {
            const list = document.getElementById('newsList');
            list.innerHTML = news.length === 0 ? '<p style="color:#666;">Keine News</p>' : news.map((item, i) => `
                <div class="news-item">
                    ${item.bild ? `<img class="preview-img" src="${item.bild}" alt="">` : `<span class="emoji">${item.emoji || 'üì¢'}</span>`}
                    <div class="info"><strong>${item.titel}</strong><small>${item.text}</small></div>
                    <button class="delete-btn" onclick="deleteNews(${i})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function renderChauffeure() {
            document.getElementById('chauffeureGrid').innerHTML = chauffeure.map((c, i) => `
                <div class="chauffeur-input">
                    <span>${i + 1}.</span>
                    <input type="text" value="${c.name}" onchange="updateChauffeurName(${i}, this.value)" placeholder="Name eingeben...">
                    <label class="checkbox-label">
                        <input type="checkbox" ${c.excluded ? 'checked' : ''} onchange="updateChauffeurExcluded(${i}, this.checked)">
                        Keine NL
                    </label>
                </div>
            `).join('');
        }

        function handleImageUpload(input) {
            const file = input.files[0];
            if (file) {
                // Compress image before storing
                compressImage(file, 150, 0.7).then(compressedBase64 => {
                    uploadedImageBase64 = compressedBase64;
                    const preview = document.getElementById('imagePreview');
                    preview.src = uploadedImageBase64;
                    preview.style.display = 'block';
                    document.getElementById('imageUploadArea').classList.add('has-image');
                    document.querySelector('#imageUploadArea .upload-text').textContent = '‚úÖ Bild geladen - Klicken zum √Ñndern';
                }).catch(err => {
                    alert('Fehler beim Laden des Bildes');
                    console.error(err);
                });
            }
        }

        function compressImage(file, maxSize, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Scale down to max size
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round(height * maxSize / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round(width * maxSize / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed JPEG
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function updateTourFahrer(i, value) { touren[i].fahrer = value; await saveTouren(); renderTouren(); }
        async function updateTourStatus(i, status) { touren[i].status = status; await saveTouren(); renderTouren(); }
        async function saveTouren() { await db.collection('settings').doc('touren').set({ list: touren }); showSuccess(); }
        async function resetTouren() { if (confirm('Alle auf Kommissionieren?')) { touren.forEach(t => t.status = 'kommissionieren'); await saveTouren(); renderTouren(); } }

        async function updateKunde(i, value) { rangliste[i].kunde = value; await saveRangliste(); }
        async function toggleAbwesend(i) { rangliste[i].abwesend = !rangliste[i].abwesend; await saveRangliste(); renderRangliste(); }
        async function moveToBottom(i) { const item = rangliste.splice(i, 1)[0]; item.kunde = ''; rangliste.push(item); await saveRangliste(); renderRangliste(); }
        async function saveRangliste() { await db.collection('settings').doc('rangliste').set({ list: rangliste }); showSuccess(); }

        async function addNews() {
            const typ = document.getElementById('newsTyp').value;
            const titel = document.getElementById('newsTitel').value;
            const text = document.getElementById('newsText').value;
            const emoji = document.getElementById('newsEmoji').value || (typ === 'birthday' ? 'üéâ' : typ === 'product' ? 'üì¶' : 'üì¢');
            if (!titel || !text) { alert('Titel und Text eingeben!'); return; }
            const newsItem = { typ, titel, text, emoji };
            if (uploadedImageBase64) newsItem.bild = uploadedImageBase64;
            news.unshift(newsItem);
            await db.collection('settings').doc('news').set({ list: news });
            document.getElementById('newsTitel').value = '';
            document.getElementById('newsText').value = '';
            document.getElementById('newsEmoji').value = '';
            document.getElementById('newsImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageUploadArea').classList.remove('has-image');
            document.querySelector('#imageUploadArea .upload-text').textContent = 'üì∑ Klicken zum Bild hochladen';
            uploadedImageBase64 = '';
            renderNews();
            showSuccess();
        }

        async function deleteNews(i) { if (confirm('L√∂schen?')) { news.splice(i, 1); await db.collection('settings').doc('news').set({ list: news }); renderNews(); showSuccess(); } }

        function updateChauffeurName(i, value) { chauffeure[i].name = value; }
        function updateChauffeurExcluded(i, checked) { chauffeure[i].excluded = checked; }

        async function saveChauffeure() {
            await db.collection('settings').doc('chauffeure').set({ list: chauffeure });
            const activeChauffeure = chauffeure.filter(c => c.name && !c.excluded);
            const newRangliste = activeChauffeure.map(c => {
                const existing = rangliste.find(r => r.fahrer === c.name);
                return existing || { fahrer: c.name, abwesend: false, kunde: '', excluded: false };
            });
            rangliste = newRangliste;
            await db.collection('settings').doc('rangliste').set({ list: rangliste });
            renderAll();
            showSuccess();
        }

        function showSuccess() {
            const msg = document.getElementById('successMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 2000);
        }
    </script>
</body>
</html>
